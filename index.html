<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPK-in dong!</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

    <div class="header">
        <h1>IPK-in dong!</h1>
        <button class="btn btn-reset" onclick="resetAll()">Reset Data</button>
    </div>

    <div class="control-bar">
        <button class="btn btn-guide" onclick="toggleGuide(true)">Panduan Penggunaan</button>
        
        <div class="export-group">
            <span style="font-size: 13px; font-weight: bold;">Sertakan dalam ekspor:</span>
            <label style="font-size: 13px; cursor: pointer;"><input type="checkbox" id="includeIPS" checked> IPS</label>
            <label style="font-size: 13px; cursor: pointer; margin-right: 15px;"><input type="checkbox" id="includeIPK" checked> IPK</label>
            
            <span>Export: </span>
            <button class="btn btn-pdf" onclick="downloadPDF()">PDF</button>
            <button class="btn btn-png" onclick="downloadPNG()">PNG</button>
        </div>
    </div>

    <div class="container" id="printableArea">
        <div class="section-title">Estimasi IPS (Indeks Prestasi Semester)</div>
        
        <div class="info-box">
            <div class="input-group">
                <label>Mahasiswa :</label>
                <input type="text" class="name-input" id="namaMahasiswa" placeholder="Ketik nama kamu...">
            </div>
            
            <div class="input-group">
                <label>Semester :</label>
                <input type="text" class="name-input" id="semesterMahasiswa" placeholder="Cth: 5">
            </div>
        </div>

        <table id="nilaiTable">
            <thead>
                <tr>
                    <th style="width: 50%;">Mata Kuliah</th>
                    <th style="width: 15%;">SKS</th>
                    <th style="width: 15%;">N. Huruf</th>
                    <th style="width: 15%;">S*N</th>
                    <th style="width: 5%;" class="aksi-col">Aksi</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <button class="btn btn-add" id="btnAddRow" data-html2canvas-ignore="true" onclick="addRow()">+ Tambah Mata Kuliah</button>
        <br><br>

        <table class="summary-table">
            <tr>
                <td class="summary-label">Jumlah SKS Semester Ini</td>
                <td class="summary-value" id="totalSKS">0</td>
            </tr>
            <tr>
                <td class="summary-label">IPS</td>
                <td class="summary-value" id="totalIPS">0.00</td>
            </tr>
        </table>

        <div class="history-section">
            <h3>Estimasi IPK (Indeks Prestasi Kumulatif)</h3>
            <p id="helperText" style="font-size: 12px; color: #666;" data-html2canvas-ignore="true">
                Isi bagian ini jika kamu ingin menggabungkan nilai semester ini dengan semester sebelumnya.
            </p>
            
            <table style="width: 60%;">
                <tr>
                    <td style="background-color: #f0f0f0; width: 60%;">Total SKS Semester Lalu</td>
                    <td><input type="number" id="prevSKS" placeholder="Cth: 80" oninput="calculate()"></td>
                </tr>
                <tr>
                    <td style="background-color: #f0f0f0;">IPK Terakhir</td>
                    <td><input type="number" step="0.01" id="prevIPK" placeholder="Cth: 3.50" oninput="calculate()"></td>
                </tr>
            </table>

            <table class="summary-table" style="margin-top: 10px;">
                <tr>
                    <td class="summary-label" style="background-color: #4a8bc2; color: white; font-size: 20px;">IPK</td>
                    <td class="summary-value" id="finalIPK" style="font-size: 20px; color: #4a8bc2;">0.00</td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top: 30px; font-size: 10px; color: #999; text-align: center;">
            Dicetak dari <i>IPK-in dong!</i> pada: <span id="printDate"></span>
        </div>
    </div>

    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-guide" onclick="toggleGuide(false)">&times;</span>
            <h2 style="color: #4a8bc2;">Panduan IPK-in dong!</h2>
            <div class="guide-body">
                <h4>Apa itu SKS?</h4>
                <p>Satuan Kredit Semester (SKS) adalah bobot beban studi tiap mata kuliah. Biasanya berkisar antara 2 sampai 4 SKS.</p>
                
                <h4>Apa itu S*N?</h4>
                <p>S*N adalah hasil perkalian antara jumlah <b>SKS</b> dengan <b>Nilai Angka</b> dari huruf yang didapat (contoh: A=4.0, B=3.0).</p>
                
                <h4>Bagaimana IPS dihitung?</h4>
                <p>IPS (Indeks Prestasi Semester) dihitung dengan membagi <b>Total S*N</b> dengan <b>Total SKS</b> yang diambil pada semester tersebut.</p>
                
                <h4>Apa bedanya dengan IPK?</h4>
                <p>IPK (Indeks Prestasi Kumulatif) adalah rata-rata gabungan dari seluruh semester yang telah ditempuh. Di web ini, kamu bisa memasukkan data semester lalu untuk melihat proyeksi nilai akhirmu.</p>
            </div>
        </div>
    </div>

    <script>
        const gradeValues = { "A": 4.0, "AB": 3.5, "B": 3.0, "BC": 2.5, "C": 2.0, "D": 1.0, "E": 0.0 };

        function toggleGuide(show) {
            document.getElementById("guideModal").style.display = show ? "block" : "none";
        }

        // Menutup modal jika user klik di luar kotak modal
        window.onclick = function(event) {
            const modal = document.getElementById("guideModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // --- FUNGSI LOCAL STORAGE ---
        function saveData() {
            const rows = document.getElementById("nilaiTable").getElementsByTagName('tbody')[0].rows;
            const courses = [];

            for (let i = 0; i < rows.length; i++) {
                courses.push({
                    nama: rows[i].cells[0].querySelector('input').value,
                    sks: rows[i].cells[1].querySelector('input').value,
                    grade: rows[i].cells[2].querySelector('select').value
                });
            }

            const data = {
                nama: document.getElementById("namaMahasiswa").value,
                semester: document.getElementById("semesterMahasiswa").value,
                prevSKS: document.getElementById("prevSKS").value,
                prevIPK: document.getElementById("prevIPK").value,
                courses: courses
            };

            localStorage.setItem('ipk_in_dong_data', JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem('ipk_in_dong_data');
            if (!savedData) {
                // Jika data kosong, beri 3 baris default
                addRow(); addRow(); addRow();
                return;
            }

            const data = JSON.parse(savedData);
            document.getElementById("namaMahasiswa").value = data.nama || "";
            document.getElementById("semesterMahasiswa").value = data.semester || "";
            document.getElementById("prevSKS").value = data.prevSKS || "";
            document.getElementById("prevIPK").value = data.prevIPK || "";

            const tbody = document.getElementById("nilaiTable").getElementsByTagName('tbody')[0];
            tbody.innerHTML = ""; // Bersihkan baris lama

            if (data.courses && data.courses.length > 0) {
                data.courses.forEach(c => {
                    const mataKuliah = c.nama || c.kode || ""; // Backward compatibility: isi nama dengan kode jika ada
                    addRow(mataKuliah, c.sks, c.grade);
                });
            } else {
                addRow(); addRow(); addRow();
            }
            calculate();
        }

        // --- LOGIKA UTAMA ---
        function addRow(nama = "", sks = 3, grade = "") {
            const table = document.getElementById("nilaiTable").getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();

            newRow.insertCell(0).innerHTML = `<input type="text" placeholder="Nama Mata Kuliah" value="${nama}" oninput="saveData()">`;
            newRow.insertCell(1).innerHTML = `<input type="number" class="sks-input" value="${sks}" min="1" oninput="calculateRow(this)">`;
            
            let selectHTML = `<select onchange="calculateRow(this)">`;
            selectHTML += `<option value="">- Pilih -</option>`;
            for (let g in gradeValues) {
                const selected = (g === grade) ? "selected" : "";
                selectHTML += `<option value="${g}" ${selected}>${g}</option>`;
            }
            selectHTML += `</select>`;
            newRow.insertCell(2).innerHTML = selectHTML;

            newRow.insertCell(3).innerHTML = `<input type="text" class="sn-input" readonly value="0">`;
            
            let cellAksi = newRow.insertCell(4);
            cellAksi.className = "aksi-col";
            cellAksi.innerHTML = `<button class="btn btn-del" onclick="removeRow(this)">X</button>`;
            
            calculateRow(newRow.querySelector('.sks-input')); // Hitung SN baris tersebut
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            calculate();
            saveData();
        }

        function calculateRow(element) {
            if(!element) return;
            let row = element.closest('tr');
            let sks = parseFloat(row.querySelector('.sks-input').value) || 0;
            let gradeLetter = row.querySelector('select').value;
            let gradePoint = gradeValues[gradeLetter] || 0;
            let sn = sks * gradePoint;
            
            row.querySelector('.sn-input').value = (gradeLetter !== "") ? sn.toFixed(1) : "0";
            
            calculate();
            saveData();
        }

        function calculate() {
            let rows = document.getElementById("nilaiTable").getElementsByTagName('tbody')[0].rows;
            let currentTotalSKS = 0;
            let currentTotalSN = 0;

            for (let i = 0; i < rows.length; i++) {
                let sks = parseFloat(rows[i].querySelector('.sks-input').value) || 0;
                let sn = parseFloat(rows[i].querySelector('.sn-input').value) || 0;
                if(sks > 0) {
                    currentTotalSKS += sks;
                    currentTotalSN += sn;
                }
            }

            document.getElementById("totalSKS").innerText = currentTotalSKS;
            let ips = (currentTotalSKS > 0) ? currentTotalSN / currentTotalSKS : 0;
            document.getElementById("totalIPS").innerText = ips.toFixed(2);

            let prevSKS = parseFloat(document.getElementById("prevSKS").value) || 0;
            let prevIPK = parseFloat(document.getElementById("prevIPK").value) || 0;
            let finalTotalSKS = prevSKS + currentTotalSKS;
            let finalTotalSN = (prevSKS * prevIPK) + currentTotalSN;
            let finalIPK = (finalTotalSKS > 0) ? finalTotalSN / finalTotalSKS : 0;

            document.getElementById("finalIPK").innerText = finalIPK.toFixed(2);
        }

        function resetAll() {
            if(confirm("Yakin reset data?")) {
                localStorage.removeItem('ipk_in_dong_data'); // Hapus memori browser
                location.reload(); // Muat ulang halaman
            }
        }

        // --- EXPORT & TIME ---
        function getTimestamp() {
            const now = new Date();
            return now.toISOString().split('T')[0] + "_" + 
                now.getHours().toString().padStart(2, '0') + "-" + 
                now.getMinutes().toString().padStart(2, '0');
        }

        function prepareForExport(isExporting) {
            const container = document.getElementById('printableArea');
            const dateSpan = document.getElementById('printDate');
            
            // Elemen-elemen yang bisa dipilih
            const ipsTable = document.getElementById('nilaiTable');
            const ipsSummary = document.querySelector('.summary-table'); // Ringkasan IPS yang pertama
            const ipsTitle = document.querySelector('.section-title');
            const ipkSection = document.querySelector('.history-section');
            
            // Status Checkbox
            const showIPS = document.getElementById('includeIPS').checked;
            const showIPK = document.getElementById('includeIPK').checked;

            if (isExporting) {
                // Sembunyikan kolom aksi
                document.querySelectorAll('.aksi-col').forEach(el => el.style.display = 'none');
                container.classList.add('print-mode');
                dateSpan.innerText = new Date().toLocaleString('id-ID');

                // Logika Sembunyikan/Tampilkan bagian berdasarkan pilihan
                if (!showIPS) {
                    ipsTable.style.display = 'none';
                    ipsSummary.style.display = 'none';
                    ipsTitle.style.display = 'none';
                }
                if (!showIPK) {
                    ipkSection.style.display = 'none';
                }
            } else {
                // Kembalikan semua ke tampilan normal di web
                document.querySelectorAll('.aksi-col').forEach(el => el.style.display = '');
                container.classList.remove('print-mode');
                dateSpan.innerText = "";
                
                ipsTable.style.display = '';
                ipsSummary.style.display = '';
                ipsTitle.style.display = '';
                ipkSection.style.display = '';
            }
        }

        function downloadPDF() {
            prepareForExport(true);
            setTimeout(() => { window.print(); prepareForExport(false); }, 500);
        }

        function downloadPNG() {
            prepareForExport(true);
            const nama = document.getElementById("namaMahasiswa").value || 'Mahasiswa';
            html2canvas(document.getElementById('printableArea'), { scale: 2 }).then(canvas => {
                let link = document.createElement('a');
                link.download = `Simulasi_KHS_${nama}_${getTimestamp()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                prepareForExport(false);
            });
        }

        // Jalankan saat halaman dibuka
        window.onload = loadData;
    </script>
</body>
</html>